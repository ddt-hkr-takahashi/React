<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>販売情報管理</title>
<link rel="stylesheet" th:href="@{/salesHistoryListMenu.css}">
<link rel="stylesheet" th:href="@{/appHeader.css}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script th:src="@{/appHeader.js}"></script>
<script th:src="@{/common.js}" type="module"></script>
<script th:src="@{/salesHistoryCommon.js}" type="module"></script>
<script th:src="@{/constants.js}" type="module"></script>
</head>
<body>

	<form id="importForm" method="post" enctype="multipart/form-data"
		style="display: none;">
		<input type="file" id="fileInput" name="file" accept=".csv" />
	</form>

	<div id="header-placeholder"></div>

	<main class="container">
		<h2>販売履歴管理</h2>

		<section class="search-form-section">
			<form id="searchForm" method="post" class="search-form-flex"
				th:action="@{/sales-history-menu/search-result}">
				<input type="hidden" id="pageInput" name="page"
					th:value="${currentPage}" />
				<div class="input-group">
					<div class="select-group">
						<label for="storeCode">店舗</label> <select name="storeCode"
							id="storeCode">
							<option value=""
								th:selected="${storeCode == null or storeCode == ''}">未選択</option>
							<option value="01" th:selected="${storeCode == '01'}">A中古車店</option>
							<option value="02" th:selected="${storeCode == '02'}">車のB店</option>
							<option value="03" th:selected="${storeCode == '03'}">中古社販売C</option>
							<option value="04" th:selected="${storeCode == '04'}">CarStoreD</option>
							<option value="05" th:selected="${storeCode == '05'}">E車販売</option>
						</select>
					</div>

					<div class="select-group">
						<label for="yearNumber">年</label> <select name="yearNumber"
							id="yearNumber">
							<option value=""
								th:selected="${yearNumber == null or yearNumber == ''}">未選択</option>
							<option
								th:each="year : ${#numbers.sequence(T(java.time.Year).now().getValue() - 5, T(java.time.Year).now().getValue())}"
								th:value="${year}" th:text="${year} + '年'"
								th:selected="${#strings.toString(year) == yearNumber}">年</option>
						</select>
					</div>

					<div class="select-group">
						<label for="monthNumber">月</label> <select name="monthNumber"
							id="monthNumber">
							<option value=""
								th:selected="${monthNumber == null or monthNumber == ''}">未選択</option>
							<option th:each="month : ${#numbers.sequence(1, 12)}"
								th:value="${#numbers.formatInteger(month, 2, 'POINT')}"
								th:text="${month} + '月'"
								th:selected="${#numbers.formatInteger(month, 2, 'POINT') == monthNumber}">月</option>
						</select>
					</div>
				</div>

				<div class="search-button-group">
					<button type="submit" id="listSearchButton" class="search-button">一覧検索</button>
					<button type="button" id="chartSearchButton" class="search-button">グラフ検索</button>
					<button type="button" id="exportCsvButton" class="search-button">CSV出力</button>
					<button type="button" id="importCsvButton" class="search-button">CSV入力</button>
					<button type="button" id="testExportCsvButton"
						class="search-button">テストCSV出力</button>
				</div>
			</form>
		</section>

		<section class="result-section">
			<h3>販売履歴一覧</h3>
			<div id="results-area" th:fragment="results-fragment">
				<p th:if="${resultCountMessage}" class="result-count-message"
					th:text="${resultCountMessage}"></p>

				<p th:if="${errorMessage}" class="error-message"
					th:text="${errorMessage}"></p>

				<div id="graph-area" style="display: none;">
					<canvas id="salesChart"></canvas>
					<button type="button" id="backToListButton"
						class="button back-button">一覧に戻る</button>
				</div>

				<table id="data-table" class="data-table"
					th:if="${resultList != null and !resultList.empty}">
					<thead>
						<tr>
							<th>都道府県</th>
							<th>店舗名</th>
							<th>支店名</th>
							<th>販売日</th>
							<th>販売額</th>
							<th>メーカー</th>
							<th>車種</th>
							<th>モデル名</th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="car : ${resultList}">
							<td th:text="${car.prefName}"></td>
							<td th:text="${car.storeName}"></td>
							<td th:text="${car.branchName}"></td>
							<td th:text="${car.PD}"></td>
							<td
								th:text="${#numbers.formatInteger(car.salesAmount, 0, 'COMMA')}"></td>
							<td th:text="${car.makerName}"></td>
							<td th:text="${car.typeName}"></td>
							<td th:text="${car.modelName}"></td>
						</tr>
					</tbody>
				</table>

				<div class="pagination" th:if="${totalPages > 1}">
					<a th:if="${currentPage > 1}"
						th:href="@{/sales-information-menu/search-result(page=${currentPage - 1}, size=100, prefCode=${param.prefCode}, branchCode=${param.branchCode}, makerCode=${param.makerCode}, typeCode=${param.typeCode}, modelCode=${param.modelCode})}">&laquo;
						前へ</a> <span
						th:with="startPage=${T(java.lang.Math).max(1, currentPage - 5)}, endPage=${T(java.lang.Math).min(totalPages, currentPage + 5)}">
						<a th:each="i : ${#numbers.sequence(startPage, endPage)}"
						th:href="@{/sales-information-menu/search-result(page=${i}, size=100, prefCode=${param.prefCode}, branchCode=${param.branchCode}, makerCode=${param.makerCode}, typeCode=${param.typeCode}, modelCode=${param.modelCode})}"
						th:classappend="${i == currentPage} ? 'active'" th:text="${i}"></a>
					</span> <a th:if="${currentPage < totalPages}"
						th:href="@{/sales-information-menu/search-result(page=${currentPage + 1}, size=100, prefCode=${param.prefCode}, branchCode=${param.branchCode}, makerCode=${param.makerCode}, typeCode=${param.typeCode}, modelCode=${param.modelCode})}">次へ
						&raquo;</a>
				</div>
			</div>
		</section>
	</main>
</body>
</html>